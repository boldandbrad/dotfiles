#!/usr/bin/env bash
#
# manage user dotfiles

help() {
  echo "dots - dotfile management"
  echo ""
  echo "Usage: dots [command]"
  echo ""
  echo "Commands:"
  echo "  add     Add an existing file or directory to dotfiles and symlink it"
  echo "  link    Symlink dotfiles"
  echo "  list    List active dotfile symlinks"
  echo "  unlink  Move symlinks targeting this repository to the trash"
  echo ""
  echo "Options:"
  echo "  -h, --help    Show this help message and exit"
  exit
}

add_help() {
  echo "dots-add - Add an existing file or directory to dotfiles and symlink it"
  echo ""
  echo "Usage: dots add [source_path] [dotfile_repo_rel_path]"
  echo ""
  echo "Example: dots add ~/.zshrc config/zsh/.zshrc"
  echo ""
  echo "Options:"
  echo "  -h, --help    Show this help message and exit"
  exit
}

add() {
  source_path="$(cd -- "$(dirname -- "$1")"; pwd)/$(basename -- "$1")"
  if [ ! -e $source_path ]; then
    echo "Cannot add $source_path: does not exist"
    exit
  fi

  dest_path="$DOTFILES/$2"
  if [ -e $dest_path ]; then
    echo "Cannot add $source_path to dotfiles: $dest_path already exists"
    exit
  fi

  dest_dir="$(dirname -- "$dest_path")"
  if [ ! -e $dest_path ]; then
    mkdir -p $dest_dir
  fi

  mv $source_path $dest_path
  ln -sn $dest_path $source_path

  echo "Added dotfile via symlink ${source_path} -> ${dest_path}"
  echo "TIP: Modify $DOTFILES/bin/dots to automatically link this dotfile in the future with 'dots link'"
  exit
}

link() {
  if [ ! -d "$XDG_CONFIG_HOME" ]; then
    mkdir $XDG_CONFIG_HOME
  fi

  ln -sn $DOTFILES/config/zsh/.zshenv $HOME/.zshenv
  ln -sn $DOTFILES/config/zsh $XDG_CONFIG_HOME/zsh
  ln -sn $DOTFILES/config/bash/.bashrc $HOME/.bashrc
  ln -sn $DOTFILES/config/bash/.bash_profile $HOME/.bash_profile
  ln -sn $DOTFILES/config/git $XDG_CONFIG_HOME/git
  ln -sn $DOTFILES/config/lazygit $XDG_CONFIG_HOME/lazygit
  ln -sn $DOTFILES/config/ghostty $XDG_CONFIG_HOME/ghostty
  ln -sn $DOTFILES/config/zellij $XDG_CONFIG_HOME/zellij
  ln -sn $DOTFILES/config/nvim $XDG_CONFIG_HOME/nvim
  ln -sn $DOTFILES/config/zed $XDG_CONFIG_HOME/zed
  ln -sn $DOTFILES/config/oh-my-posh $XDG_CONFIG_HOME/oh-my-posh
  ln -sn $DOTFILES/config/bat $XDG_CONFIG_HOME/bat

  if [[ "$OSTYPE" == "darwin"* ]]; then
    ln -sn $DOTFILES/config/sketchybar $XDG_CONFIG_HOME/sketchybar
    ln -sn $DOTFILES/util/com.boldandbrad.CapsLockEscape.plist $HOME/Library/LaunchAgents/com.boldandbrad.CapsLockEscape.plist
  fi
  echo "Symlinked dotfiles."
  exit
}

list() {
  find ~/ -maxdepth 3 -type l -lname "$(pwd)*" 2>/dev/null
  exit
}

unlink() {
  find ~/ -maxdepth 3 -type l -lname "$(pwd)*" 2>/dev/null | xargs trash
  echo "Dotfile symlinks moved to trash."
  exit
}

while test $# -gt 0; do
  case "$1" in
    "add")
      shift
      if [ $# = 2 ]; then
        add $1 $2
      else
        add_help
      fi
      ;;
    "link")
      link
      ;;
    "list")
      list
      ;;
    "unlink")
      unlink
      ;;
    *)
      help
      ;;
  esac
  shift
done

