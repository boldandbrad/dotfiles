#!/usr/bin/env bash
#
# mac system utility

PROMPT_TIMEOUT=15 # When user is prompted for input, skip after x seconds

help() {
  echo "mac - mac system utility"
  echo ""
  echo "Usage: mac [command]"
  echo ""
  echo "Commands:"
  echo "  set        Apply system settings"
  echo "  deps       Manage packages and applications"
  echo "  info       Show system information"
  echo "  update     Check for and install system updates"
  exit
}

deps_help() {
  echo "mac-deps - Manage packages and applications"
  echo ""
  echo "Usage: mac deps [command]"
  echo ""
  echo "Commands:"
  echo "  install  Install packages and applications"
  echo "  prune    Uninstall packages and applications not listed in the Brewfile"
  exit
}

deps_install() {
  # install homebrew if not already installed
  echo -e "Checking for Homebrew..."
  if ! type brew &>/dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || exit 1

    export PATH=/opt/homebrew/bin:$PATH

    # configure homebrew
    brew developer off
    brew analytics off

    echo -e "${GREEN_B}Homebrew is now installed.${RESET}"
  else
    echo -e "${GREEN_B}Homebrew is installed.${RESET}"
  fi

  # install apps and packages from Brewfile
  echo
  if ! brew bundle check; then
    echo "Installing macOS apps and packages from Brewfile..."
    brew bundle
  fi
  exit
}

deps_prune() {
  echo "Removing deps not listed in Brewfile..."
  brew bundle cleanup
  exit
}

info_help() {
  echo "mac-info - Show system information"
  echo ""
  echo "Usage: mac info [command]"
  echo ""
  echo "Commands:"
  echo "  hardware      Show mac hardware info"
  echo "  software      Show mac software info"
  echo "  serial        Show mac serial number"
  exit
}

info_hardware() {
  system_profiler SPHardwareDataType | tail -n +4
  exit
}

info_software() {
  system_profiler SPSoftwareDataType | tail -n +4
  exit
}

info_serial() {
  system_profiler SPHardwareDataType | grep "Serial Number (system)" | awk '{ print $4 }'
  exit
}

settings() {
  # quit any active System Settings windows to avoid overriding settings
  osascript -e 'tell application "System Settings" to quit'

  # hush terminal login messages
  touch ~/.hushlogin

  # set desktop wallpaper - NOTE: this may cause macOS to prompt the user to provide their terminal emulator with home folder access
  osascript -e "tell application \"System Events\" to tell every desktop to set picture to \"~/Dotfiles/util/wallpapers/catppuccin-gradient.png\" as POSIX file"
  echo "Desktop wallpaper set."

  # map caps lock key to escape - courtesy of https://stackoverflow.com/a/46460200/19295049
  if type hidutil &>/dev/null; then
    hidutil property --set '{"UserKeyMapping":[{"HIDKeyboardModifierMappingSrc":0x700000039,"HIDKeyboardModifierMappingDst":0x700000029}]}'
    plist_location=~/Library/LaunchAgents/com.boldandbrad.CapsLockEscape.plist
    if [ ! -f $plist_location ]; then
      ln -s $DOTFILES/util/com.boldandbrad.CapsLockEscape.plist $plist_location
    fi
    if launchctl list | grep -q com.boldandbrad.CapsLockEscape; then
      launchctl load $plist_location
    fi
    echo "Caps Lock key remapped to Escape."
  fi
  exit
}

update() {
  echo "Checking for available macOS software updates..."
  if softwareupdate -l 2>&1 | grep -q $Q "No new software available."; then
    echo "No new software available."
  else
    echo "Software updates available:"
    softwareupdate -l | tail -n +4

    echo -en "\nWould you like to install the available updates? (y/N): "
    read -t $PROMPT_TIMEOUT -n 1 -r ans_update && echo
    if [[ ! $ans_update =~ ^[Yy]$ ]] ; then
      echo -e "\nSkipping system updates."
      exit
    fi
    sudo softwareupdate --install --all --restart
  fi
  exit
}

if [[ "$OSTYPE" == "darwin"* ]]; then
  while test $# -gt 0; do
    case "$1" in
      "deps")
        case "$2" in
          "install")
            deps_install
            ;;
          *)
            deps_help
            ;;
        esac
        shift
        ;;
      "info")
        case "$2" in
          "hardware")
            info_hardware
            ;;
          "software")
            info_software
            ;;
          "serial")
            info_serial
            ;;
          *)
            info_help
            ;;
        esac
        shift
        ;;
      "set")
        settings
        ;;
      "update")
        update
        ;;
      *)
        help
        ;;
    esac
    shift
  done
  help
else
  echo "Unsupported system: $OSTYPE"
fi
