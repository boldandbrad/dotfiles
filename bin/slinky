#!/bin/sh

# slinky: simple dotfile symlink management

DOTFILES="${DOTFILES:?Slinky requires the DOTFILES environment variable is set to the path of your dotfiles repository}"
if [ ! -d "$DOTFILES" ]; then
  echo "Error: DOTFILES ('$DOTFILES') is not a directory or cannot be accessed." >&2
  exit 1
fi
MAPPINGS_FILE="$DOTFILES/slinky.map"

tilde_expand() {
  v="$1"
  if [ "$v" = "~" ]; then
    echo "$HOME"
  else
    rest=$(printf '%s' "$v" | sed 's#^~\/##')
    if [ "$rest" != "$v" ]; then
      echo "$HOME/$rest"
    else
      echo "$v"
    fi
  fi
}

help() {
  cat <<'EOF'
slinky - dotfile symlink management
Usage: slinky <command> [args]
Commands:
  add <src> [repo_rel_path]    Add a file or directory to dotfiles, symlink it, and track it in slinky.map (repo_rel_path optional)
  install                      Install dotfile symlinks tracked in slinky.map
  drop <repo_rel_path>         Drop a file or directory from dotfiles and slinky.map, returning it to its original location
  find                         Find active symlinks pointing to this repository
  init                         Create bare slinky.map file if it does not exist
  list                         List symlinks tracked in slinky.map
  uninstall                    Uninstall dotfile symlinks tracked in slinky.map by deleting them
  help|-h|--help               Show this help
EOF
}

init() {
  [ -f "$MAPPINGS_FILE" ] || {
    printf "# slinky.map - symlinks managed by slinky\n" > "$MAPPINGS_FILE";
    echo "Created '$MAPPINGS_FILE'"
  }
}

add_link() {
  input_path="$1"
  repo_rel_path="$2"

  source_path="$(cd "$(dirname "$input_path")" && pwd)/$(basename "$input_path")"
  if [ ! -e "$source_path" ]; then
    echo "Cannot add '$source_path' to dotfiles: does not exist" >&2; return
  fi

  base=$(basename "$source_path")

  dest_path=""
  mapping_entry=""
  home_tgt=""
  case "$source_path" in
    "$HOME"*)
      rel_path="${source_path#"$HOME"}"
      home_tgt="~${rel_path}"
      ;;
    *)
      home_tgt="$source_path"
      ;;
  esac

  if [ -n "$repo_rel_path" ]; then
    norm_repo_rel="${repo_rel_path%/}"
    if [ -n "$norm_repo_rel" ]; then
      dest_path="$DOTFILES/$norm_repo_rel/$base"
      mapping_entry="$norm_repo_rel/$base|$home_tgt"
    else
      dest_path="$DOTFILES/$base"
      mapping_entry="$base|$home_tgt"
    fi
  else
    dest_path="$DOTFILES/$base"
    mapping_entry="$base|$home_tgt"
  fi

  if [ -e "$dest_path" ]; then
    echo "Cannot add '$source_path' to dotfiles: '$dest_path' already exists" >&2; return
  fi

  dest_dir="$(dirname "$dest_path")"
  if [ ! -e "$dest_path" ]; then
    mkdir -p "$dest_dir"
  fi

  mv "$source_path" "$dest_path"
  ln -sn "$dest_path" "$source_path"

  printf "%s\n" "$mapping_entry" >> "$MAPPINGS_FILE"

  echo "Added dotfile '$dest_path' via symlink at '$source_path'"
}

install_links() {
  echo "Installing dotfile symlinks from '$MAPPINGS_FILE'"

  while IFS= read -r line; do
    case "$line" in
      ''|'#'* ) continue ;;
    esac

    src=$(printf '%s' "$line" | cut -d'|' -f1)
    tgt=$(printf '%s' "$line" | cut -d'|' -f2-)
    abs_src="$DOTFILES/$src"
    abs_tgt="$(tilde_expand "$tgt")"
    if [ ! -e "$abs_src" ]; then
      echo "  Source not found: '$abs_src'" >&2
      continue
    fi

    if [ -e "$abs_tgt" ] || [ -L "$abs_tgt" ]; then
      echo "  Target exists: '$abs_tgt'" >&2
      continue
    fi

    mkdir -p "$(dirname "$abs_tgt")"
    ln -s "$abs_src" "$abs_tgt" || echo "  Failed linking $abs_src -> $abs_tgt" >&2
  done < "$MAPPINGS_FILE"
}

uninstall_links() {
  # Remove targets; then prune mappings file
  while IFS= read -r line; do
    case "$line" in ''|'#'* ) continue ;;
    esac
    src=$(printf '%s' "$line" | cut -d'|' -f1)
    tgt=$(printf '%s' "$line" | cut -d'|' -f2-)
    abs_tgt="$(tilde_expand "$tgt")"
    if [ -L "$abs_tgt" ] || [ -e "$abs_tgt" ]; then
      rm -f "$abs_tgt" 2>/dev/null
    fi
  done < "$MAPPINGS_FILE"

  # Prune the mappings file in-place by filtering out removed entries is optional here
  echo "Uninstalled dotfile symlinks tracked in slinky.map by deleting them"
}

drop_link() {
  repo_rel_path="$1"

  line=$(awk -v s="$repo_rel_path" -F'|' '$1 == s { print; exit }' "$MAPPINGS_FILE")
  if [ -z "$line" ]; then
    echo "Cannot drop dotfile '$repo_rel_path': no mapping found in '$MAPPINGS_FILE'." >&2; return
  fi
  src=$(printf '%s' "$line" | cut -d'|' -f1)
  tgt=$(printf '%s' "$line" | cut -d'|' -f2-)

  abs_src="$DOTFILES/$src"
    abs_tgt="$(tilde_expand "$tgt")"

  if [ -L "$abs_tgt" ] || [ -e "$abs_tgt" ]; then
    rm -f "$abs_tgt" 2>/dev/null
  fi

  mkdir -p "$(dirname "$abs_tgt")"
  if [ -e "$abs_src" ]; then
    mv "$abs_src" "$abs_tgt"
    echo "Dropped dotfile '$repo_rel_path' and moved it back to '$abs_tgt'"
  else
    echo "Cannot drop dotfile '$repo_rel_path': expected dotfiles content not found at '$abs_src'" >&2
  fi

  tmp=$(mktemp)
  awk -v s="$repo_rel_path" -F'|' '$1 != s { print }' "$MAPPINGS_FILE" > "$tmp" && mv "$tmp" "$MAPPINGS_FILE"
}

find_links() {
  find ~/ -maxdepth 3 -type l -lname "$DOTFILES*" 2>/dev/null
}

list_links() {
  while IFS= read -r line; do
    case "$line" in
      ''|'#'*) continue ;;
    esac
    src=$(printf '%s' "$line" | cut -d'|' -f1)
    tgt=$(printf '%s' "$line" | cut -d'|' -f2-)
    printf "%s -> %s\n" "$src" "$tgt"
  done < "$MAPPINGS_FILE"
}

if [ ! -f "$MAPPINGS_FILE" ]; then
  echo "'$MAPPINGS_FILE' not found. Create it with 'slinky init'" >&2; exit 1
fi

case "$1" in
  add)
    shift
    if [ $# -ge 2 ]; then
      add_link "$1" "$2"
    elif [ $# -ge 1 ]; then
      add_link "$1" ""
    else
      help
    fi
    ;;
  install)
    install_links
    ;;
  drop)
    shift
    if [ $# -ge 1 ]; then
      drop_link "$1"
    else
      help
    fi
    ;;
  find)
    find_links
    ;;
  init)
    init
    ;;
  list)
    list_links
    ;;
  uninstall)
    uninstall_links
    ;;
  help|"-h"|"--help")
    help
    ;;
  *)
    help
    ;;
esac
